{"version":3,"sources":["../../../../src/commands/run/ios/ExpoLogFormatter.ts"],"names":["ERROR","cachedPackages","packageJsonForPath","filePath","packageJson","findUp","sync","cwd","require","moduleNameFromPath","modulePath","startsWith","org","packageName","split","join","getNodeModuleName","CustomParser","Parser","constructor","formatter","parse","text","results","checkMetroError","isCollectingMetroError","metroError","formatMetroAssetCollectionError","length","match","trim","push","ExpoLogFormatter","Formatter","props","nativeProjectRoot","path","projectRoot","parser","errorContents","chalk","red","errors","shouldShowCompileWarning","lineNumber","columnNumber","Log","isDebug","getFileOperationTitle","type","formatFileOperation","title","moduleNameTag","getPkgName","target","format","formatBreadCrumb","fileName","project","filter","Boolean","formatPhaseScriptExecution","scriptName","moduleName","appName","pkg","packageJsonForProject","name","cyan","Object","values","podfile","finish","log","warnings"],"mappings":"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","sourcesContent":["import { FileOperation, Formatter, Parser } from '@expo/xcpretty';\nimport { switchRegex } from '@expo/xcpretty/build/switchRegex';\nimport chalk from 'chalk';\nimport findUp from 'find-up';\nimport path from 'path';\n\nimport Log from '../../../log';\n\nconst ERROR = '‚ùå ';\n\nconst cachedPackages: Record<string, any> = {};\n\nfunction packageJsonForPath(filePath: string): any {\n  const packageJson = findUp.sync('package.json', { cwd: filePath });\n  if (packageJson) {\n    return require(packageJson);\n  }\n  return null;\n}\n\nfunction moduleNameFromPath(modulePath: string) {\n  if (modulePath.startsWith('@')) {\n    const [org, packageName] = modulePath.split('/');\n    if (org && packageName) {\n      return [org, packageName].join('/');\n    }\n    return modulePath;\n  }\n  const [packageName] = modulePath.split('/');\n  return packageName ? packageName : modulePath;\n}\n\nfunction getNodeModuleName(filePath: string): string | null {\n  // '/Users/evanbacon/Documents/GitHub/lab/yolo5/node_modules/react-native-reanimated/ios/Nodes/REACallFuncNode.m'\n  const [, modulePath] = filePath.split('/node_modules/');\n  if (modulePath) {\n    return moduleNameFromPath(modulePath);\n  }\n  return null;\n}\n\nclass CustomParser extends Parser {\n  private isCollectingMetroError = false;\n  private metroError: string[] = [];\n\n  constructor(public formatter: ExpoLogFormatter) {\n    super(formatter);\n  }\n\n  parse(text: string): void | string {\n    const results = this.checkMetroError(text);\n    if (results) {\n      return results;\n    }\n    return super.parse(text);\n  }\n\n  // Error for the build script wrapper in expo-updates that catches metro bundler errors.\n  // This can be repro'd by importing a file that doesn't exist, then building.\n  // Metro will fail to generate the JS bundle, and throw an error that should be caught here.\n  checkMetroError(text: string) {\n    // In expo-updates, we wrap the bundler script and add regex around the error message so we can present it nicely to the user.\n    return switchRegex(text, [\n      [\n        /@build-script-error-begin/m,\n        () => {\n          this.isCollectingMetroError = true;\n        },\n      ],\n      [\n        /@build-script-error-end/m,\n        () => {\n          const results = this.metroError.join('\\n');\n          // Reset the metro collection error array (should never need this).\n          this.isCollectingMetroError = false;\n          this.metroError = [];\n          return this.formatter.formatMetroAssetCollectionError(results);\n        },\n      ],\n      [\n        null,\n        () => {\n          // Collect all the lines in the metro build error\n          if (this.isCollectingMetroError) {\n            let results = text;\n            if (!this.metroError.length) {\n              const match = text.match(\n                /Error loading assets JSON from Metro.*steps correctly.((.|\\n)*)/m\n              );\n              if (match && match[1]) {\n                results = match[1].trim();\n              }\n            }\n            this.metroError.push(results);\n          }\n        },\n      ],\n    ]);\n  }\n}\n\ntype CustomProps = {\n  projectRoot: string;\n  podfile: Record<string, Record<string, string>>;\n  appName: string;\n};\n\nexport class ExpoLogFormatter extends Formatter {\n  private nativeProjectRoot: string;\n\n  constructor(public props: CustomProps) {\n    super(props);\n    this.nativeProjectRoot = path.join(props.projectRoot, 'ios');\n    this.parser = new CustomParser(this);\n  }\n\n  formatMetroAssetCollectionError(errorContents: string): string {\n    const results = `\\n${chalk.red(\n      ERROR +\n        // Provide proper attribution.\n        'Metro encountered an error:\\n' +\n        errorContents\n    )}\\n`;\n    this.errors.push(results);\n    return results;\n  }\n\n  shouldShowCompileWarning(filePath: string, lineNumber?: string, columnNumber?: string): boolean {\n    if (Log.isDebug) {\n      return true;\n    }\n    return !filePath.match(/node_modules/) && !filePath.match(/\\/ios\\/Pods\\//);\n  }\n\n  getFileOperationTitle(type: FileOperation['type']): string {\n    switch (type) {\n      case 'Analyze':\n        return 'Analyzing';\n      case 'GenerateDSYMFile':\n        return `Generating debug`;\n      case 'Ld':\n        return 'Linking';\n      case 'Libtool':\n        return 'Building lib';\n      case 'ProcessPCH':\n        return 'Precompiling';\n      case 'ProcessInfoPlistFile':\n        return 'Processing';\n      case 'CodeSign':\n        return 'Signing';\n      case 'Touch':\n        return 'Creating';\n      case 'CompileC':\n      case 'CompileSwift':\n      case 'CompileXIB':\n      case 'CompileStoryboard':\n        return 'Compiling';\n      default:\n        // Unknown file operation\n        return '';\n    }\n  }\n\n  formatFileOperation(props: FileOperation): string {\n    const title = this.getFileOperationTitle(props.type);\n    const moduleNameTag = this.getPkgName(props.filePath, props.target);\n    return Formatter.format(\n      title,\n      [moduleNameTag, Formatter.formatBreadCrumb(props.fileName, props.target, props.project)]\n        .filter(Boolean)\n        .join(' ')\n    );\n  }\n\n  formatPhaseScriptExecution(scriptName: string, target?: string, project?: string): string {\n    const moduleNameTag = this.getPkgName('', target);\n\n    return Formatter.format(\n      'Running script',\n      [moduleNameTag, Formatter.formatBreadCrumb(scriptName, target, project)]\n        .filter(Boolean)\n        .join(' ')\n    );\n  }\n\n  private getPkgName(filePath: string, target?: string): string | null {\n    let moduleName = getNodeModuleName(filePath);\n    if (!moduleName) {\n      if (target === this.props.appName || target === `Pods-${this.props.appName}`) {\n        moduleName = '';\n      } else {\n        const pkg = this.packageJsonForProject(target);\n        if (pkg) {\n          moduleName = pkg.name;\n        }\n      }\n    }\n    return moduleName ? chalk.cyan(`${moduleName}`) : null;\n  }\n\n  private packageJsonForProject(project?: string): any {\n    if (!project) {\n      return null;\n    }\n\n    if (project in cachedPackages) {\n      return cachedPackages[project];\n    }\n\n    const filePath = Object.values(this.props.podfile[project] || {})[0] ?? null;\n    if (!filePath) {\n      return null;\n    }\n\n    const pkg = packageJsonForPath(path.join(this.nativeProjectRoot, filePath as string));\n    if (pkg) {\n      cachedPackages[project] = pkg;\n    }\n    return pkg ?? null;\n  }\n\n  finish() {\n    Log.log(`\\n\\u203A ${this.errors.length} error(s), and ${this.warnings.length} warning(s)\\n`);\n  }\n}\n"],"file":"ExpoLogFormatter.js"}